<!--
  SealMetrics Tracking for BigCommerce

  INSTALLATION:
  1. Go to BigCommerce Admin > Storefront > Script Manager
  2. Click "Create a Script"
  3. Name: SealMetrics Tracking
  4. Location: Head
  5. Pages: All Pages
  6. Script type: Script
  7. Paste this entire script block
  8. Replace YOUR_ACCOUNT_ID with your SealMetrics Account ID
  9. Save
-->

<script>
/**
 * SealMetrics Tracking for BigCommerce v1.0.0
 * https://sealmetrics.com
 */
(function(){'use strict';var CONFIG={accountId:'YOUR_ACCOUNT_ID',debugMode:false,attributeMap:{color:'colour',colour:'colour',size:'size',talla:'size',material:'material',weight:'weight'}};if(!CONFIG.accountId||CONFIG.accountId==='YOUR_ACCOUNT_ID'){console.warn('[SealMetrics] Please configure your Account ID');return}window.sealmetricsTrack=window.sealmetricsTrack||[];window.sealmetricsDebug=CONFIG.debugMode;window.sealmetricsLoaded=false;window.sealmetricsPageviewSent=false;function smLog(m,d){if(window.sealmetricsDebug)console.log('[SealMetrics]',m,d||'')}window.smLog=smLog;function processQueue(){if(typeof sealmetrics!=='undefined'&&sealmetrics.track){while(window.sealmetricsTrack.length>0){var e=window.sealmetricsTrack.shift();smLog('Processing:',e);sealmetrics.track(e)}}}var origPush=window.sealmetricsTrack.push;window.sealmetricsTrack.push=function(){var r=origPush.apply(this,arguments);if(window.sealmetricsLoaded)processQueue();return r};var s=document.createElement('script');s.src='https://cdn.sealmetrics.com/'+CONFIG.accountId+'/sm.js';s.async=true;s.onload=function(){window.sealmetricsLoaded=true;smLog('Loaded');processQueue()};document.head.appendChild(s);if(!window.sealmetricsPageviewSent){window.sealmetricsPageviewSent=true;window.sealmetricsTrack.push({event:'pageview',use_session:1})}function normalizeAttr(n){if(!n)return'';n=n.toLowerCase().replace(/[^a-z0-9]/g,'');return CONFIG.attributeMap[n]||n}function parsePrice(p){if(typeof p==='number')return p;if(!p)return 0;return parseFloat(p.replace(/[^0-9.,]/g,'').replace(',','.'))||0}function getPageType(){var b=document.body;if(b.classList.contains('page-type-product'))return'product';if(b.classList.contains('page-type-category'))return'category';if(b.classList.contains('page-type-cart'))return'cart';if(b.classList.contains('page-type-checkout'))return'checkout';if(b.classList.contains('page-type-orderconfirmation'))return'order_confirmation';return'other'}function extractProductData(){var d={sku:'',price:0};var jsonLd=document.querySelector('script[type="application/ld+json"]');if(jsonLd){try{var s=JSON.parse(jsonLd.textContent);if(s['@type']==='Product'){d.sku=s.sku||'';if(s.offers){var o=Array.isArray(s.offers)?s.offers[0]:s.offers;d.price=parsePrice(o.price)}}}catch(e){}}if(!d.sku){var skuEl=document.querySelector('meta[itemprop="sku"],[data-product-sku]');if(skuEl)d.sku=skuEl.getAttribute('content')||skuEl.getAttribute('data-product-sku')||''}if(!d.price){var priceEl=document.querySelector('.productView-price .price--withoutTax,.productView-price .price-value');if(priceEl)d.price=parsePrice(priceEl.textContent)}return d}function getSelectedOptions(){var opts={};document.querySelectorAll('.productView-options select,[data-product-option-change] select').forEach(function(sel){var lbl=sel.closest('.form-field')?.querySelector('.form-label,label')?.textContent.replace(/[*:]/g,'').trim()||'';var val=sel.options[sel.selectedIndex]?.text||'';if(lbl&&val&&val!=='Choose an option')opts[normalizeAttr(lbl)]=val.trim()});document.querySelectorAll('.productView-options input[type="radio"]:checked').forEach(function(r){var lbl=r.closest('.form-field,fieldset')?.querySelector('.form-label,legend')?.textContent.replace(/[*:]/g,'').trim()||'';var val=r.nextElementSibling?.textContent||r.value||'';if(lbl&&val)opts[normalizeAttr(lbl)]=val.trim()});return opts}function getQty(){var q=document.querySelector('.form-input--incrementTotal,input[name="qty[]"]');return q?parseInt(q.value,10)||1:1}function trackProductView(){var p=extractProductData();if(!p.sku&&!p.price)return;var opts=getSelectedOptions();var props=Object.assign({sku:p.sku},opts);Object.keys(props).forEach(function(k){if(!props[k])delete props[k]});window.sealmetricsTrack.push({event:'microconversion',label:'product_view',amount:p.price,properties:props});smLog('product_view:',props);window.sealmetricsProductData=p}function trackAddToCart(sku,price,qty,attrs){var props=Object.assign({sku:sku||''},attrs||{});Object.keys(props).forEach(function(k){if(!props[k])delete props[k]});window.sealmetricsTrack.push({event:'microconversion',label:'add-to-cart',amount:(price||0)*(qty||1),properties:props});smLog('add-to-cart:',props)}function getCartData(){return fetch('/api/storefront/carts',{credentials:'include'}).then(function(r){return r.json()}).then(function(carts){if(carts&&carts.length>0){var c=carts[0];var skus=[],cnt=0,attrs={};if(c.lineItems&&c.lineItems.physicalItems){c.lineItems.physicalItems.forEach(function(i){skus.push(i.sku||'PROD-'+i.productId);cnt+=i.quantity;if(i.options){i.options.forEach(function(o){var n=normalizeAttr(o.name);if(!attrs[n])attrs[n]=[];if(attrs[n].indexOf(o.value)===-1)attrs[n].push(o.value)})}})}var flatAttrs={};Object.keys(attrs).forEach(function(k){flatAttrs[k]=attrs[k].join(',')});return{amount:c.baseAmount||0,skus:skus.join(','),itemCount:cnt,currency:c.currency?.code||'USD',attributes:flatAttrs}}return null}).catch(function(){return null})}function trackCheckout(step,amt,skus,cnt){window.sealmetricsTrack.push({event:'microconversion',label:'checkout'+step,amount:amt||0,properties:{sku:skus||'',item_count:cnt||0}});smLog('checkout'+step)}function trackPurchase(amt,skus,cnt,cur,attrs){var props=Object.assign({sku:skus||'',currency:cur||'USD',item_count:cnt||0},attrs||{});Object.keys(props).forEach(function(k){if(!props[k]&&props[k]!==0)delete props[k]});window.sealmetricsTrack.push({event:'conversion',label:'purchase',amount:amt||0,properties:props});smLog('purchase:',props)}function initAddToCart(){document.addEventListener('click',function(e){var btn=e.target.closest('#form-action-addToCart,.card-figcaption-button,[data-button-type="add-cart"]');if(!btn)return;var p=window.sealmetricsProductData||extractProductData();var opts=getSelectedOptions();var qty=getQty();setTimeout(function(){trackAddToCart(p.sku,p.price,qty,opts)},100)})}function initCheckout(){var pt=getPageType();if(pt==='cart'){getCartData().then(function(c){if(c)trackCheckout(1,c.amount,c.skus,c.itemCount)});document.addEventListener('click',function(e){if(e.target.closest('.cart-actions .button--primary,[data-cart-checkout]')){getCartData().then(function(c){if(c)trackCheckout(2,c.amount,c.skus,c.itemCount)})}})}if(pt==='checkout'){getCartData().then(function(c){if(c&&!window.smC2){window.smC2=true;trackCheckout(2,c.amount,c.skus,c.itemCount)}});document.addEventListener('click',function(e){if(e.target.closest('#checkout-payment-continue,[data-test="place-order-button"]')&&!window.smC3){window.smC3=true;getCartData().then(function(c){if(c)trackCheckout(3,c.amount,c.skus,c.itemCount)})}})}}function initPurchase(){if(getPageType()!=='order_confirmation')return;var tk='sm_purch';var oEl=document.querySelector('[data-test="order-confirmation-order-number"]');var oId=oEl?oEl.textContent.trim():'';if(oId){var tr=JSON.parse(localStorage.getItem(tk)||'[]');if(tr.indexOf(oId)!==-1)return;tr.push(oId);if(tr.length>50)tr=tr.slice(-50);localStorage.setItem(tk,JSON.stringify(tr))}var amt=0;var stEl=document.querySelector('[data-test="order-confirmation-subtotal"],.cart-priceItem--subtotal .cart-priceItem-value');if(stEl)amt=parsePrice(stEl.textContent);var cur='USD';var skus=[],cnt=0,attrs={};document.querySelectorAll('.productList-item,.orderConfirmation-product').forEach(function(i){var skEl=i.querySelector('[data-test="product-sku"],.productList-item-sku');var sk=skEl?skEl.textContent.replace('SKU:','').trim():'';if(sk)skus.push(sk);var qEl=i.querySelector('[data-test="product-quantity"]');cnt+=qEl?parseInt(qEl.textContent.replace(/[^0-9]/g,''),10):1});if(amt>0||skus.length>0)trackPurchase(amt,skus.join(','),cnt,cur,{})}function init(){var pt=getPageType();smLog('Page:',pt);if(pt==='product'){trackProductView();initAddToCart()}else if(pt==='category'){initAddToCart()}else if(pt==='cart'||pt==='checkout'){initCheckout()}else if(pt==='order_confirmation'){initPurchase()}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}window.sealmetricsTrackProductView=trackProductView;window.sealmetricsTrackAddToCart=trackAddToCart;window.sealmetricsTrackCheckout=trackCheckout;window.sealmetricsTrackPurchase=trackPurchase})();
</script>
